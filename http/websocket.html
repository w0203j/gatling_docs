

<ol class="breadcrumb">
  <li><a href="../index.html">Gatling documentation</a></li>
  <li><a href="index.html" accesskey="U">
    HTTP
    </a>
  </li>
  <li><a href="">
    WebSocket
  </a></li>
</ol>

<div class="content-left-wrap col-md-9">
  <div id="primary" class="content-area">
    <main itemscope="" itemtype="http://schema.org/WebPageElement" itemprop="mainContentOfPage" id="main"
          class="site-main">
      <article id="documentation" class="type-post status-publish format-standard hentry category-non-classe">
        <header class="entry-header">
          <h1 class="entry-title" itemprop="headline">WebSocket</h1>
        </header>
        <div class="entry-content" itemprop="text">
          
          <div class="section" id="websocket">
<span id="http-ws"></span>
<p>Functional specs support was initially contributed by <a class="reference external" href="https://github.com/amjjd">Andrew Duffy</a>.</p>
<p>WebSocket support is an extension to the HTTP DSL, whose entry point is the <code class="docutils literal"><span class="pre">ws(requestName:</span> <span class="pre">Expression[String])</span></code> method.</p>
<p>WebSocket protocol is very different from the HTTP one as the communication is 2 ways: both client-to-server and server-to-client, so the model is different from the HTTP request/response pair.</p>
<p>As a consequence, main HTTP branch and a WebSocket branch can exist in a Gatling scenario in a dissociated way, in parallel.
When doing so, each flow branch has it’s own state, so a user might have to reconciliate them, for example when capturing data from a websocket check and wanting this data to be available to the HTTP branch.</p>
<div class="section" id="common-operations">
<h2>Common operations<a class="headerlink" href="#common-operations" title="Permalink to this headline">¶</a></h2>
<p id="http-ws-name">If you want to deal with several WebSockets per virtual users, you have to give them a name and pass this name on each ws operation:</p>
<p><code class="docutils literal"><span class="pre">wsName(name:</span> <span class="pre">String)</span></code></p>
<p>For example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="n">ws</span><span class="o">(</span><span class="s">&quot;WS Operation&quot;</span><span class="o">).</span><span class="n">wsName</span><span class="o">(</span><span class="s">&quot;myCustomName&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>Of course, this step is not required if you deal with one single WebSocket per virtual user.</p>
<div class="section" id="open">
<span id="http-ws-open"></span><h3>Open<a class="headerlink" href="#open" title="Permalink to this headline">¶</a></h3>
<p>The first thing is to open a WebSocket:</p>
<p><code class="docutils literal"><span class="pre">open(url:</span> <span class="pre">Expression[String])</span></code></p>
<p>For example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="n">exec</span><span class="o">(</span><span class="n">ws</span><span class="o">(</span><span class="s">&quot;Connect WS&quot;</span><span class="o">).</span><span class="n">open</span><span class="o">(</span><span class="s">&quot;/room/chat?username=steph&quot;</span><span class="o">))</span>
</pre></div>
</div>
</div>
<div class="section" id="close">
<span id="http-ws-close"></span><h3>Close<a class="headerlink" href="#close" title="Permalink to this headline">¶</a></h3>
<p>When you’re done with a WebSocket, you can close it:</p>
<p><code class="docutils literal"><span class="pre">close</span></code></p>
<p>For example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="n">exec</span><span class="o">(</span><span class="n">ws</span><span class="o">(</span><span class="s">&quot;Close WS&quot;</span><span class="o">).</span><span class="n">close</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="section" id="send-a-message">
<span id="http-ws-send"></span><h3>Send a Message<a class="headerlink" href="#send-a-message" title="Permalink to this headline">¶</a></h3>
<p>One can send 2 forms of messages: binary and text:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">sendText(text:</span> <span class="pre">Expression[String])</span></code></li>
<li><code class="docutils literal"><span class="pre">sendBytes(bytes:</span> <span class="pre">Expression[Array[Byte]])</span></code></li>
</ul>
<p>For example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="n">exec</span><span class="o">(</span><span class="n">ws</span><span class="o">(</span><span class="s">&quot;Message&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">sendText</span><span class="o">(</span><span class="s">&quot;&quot;&quot;{&quot;text&quot;: &quot;Hello, I&#39;m ${id} and this is message ${i}!&quot;}&quot;&quot;&quot;</span><span class="o">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="server-messages-checks">
<h2>Server Messages: Checks<a class="headerlink" href="#server-messages-checks" title="Permalink to this headline">¶</a></h2>
<p>Dealing with incoming messages from the server is done with checks, passed with the usual <code class="docutils literal"><span class="pre">check()</span></code> method.</p>
<p>Gatling currently only support one check at a time per WebSocket.</p>
<div class="section" id="set-a-check">
<span id="http-ws-check-set"></span><h3>Set a Check<a class="headerlink" href="#set-a-check" title="Permalink to this headline">¶</a></h3>
<p>Checks can be set in 2 ways.</p>
<p>First, when sending a message:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="n">exec</span><span class="o">(</span><span class="n">ws</span><span class="o">(</span><span class="s">&quot;Send&quot;</span><span class="o">).</span><span class="n">sendText</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">).</span><span class="n">check</span><span class="o">(</span><span class="n">myCheck</span><span class="o">))</span>
</pre></div>
</div>
<p>Then, directly from the main HTTP flow:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="n">exec</span><span class="o">(</span><span class="n">ws</span><span class="o">(</span><span class="s">&quot;Set Check&quot;</span><span class="o">).</span><span class="n">check</span><span class="o">(</span><span class="n">myCheck</span><span class="o">))</span>
</pre></div>
</div>
<p>If a check was already registered on the WebSocket at this time, it’s considered as failed and replaced with the new one.</p>
</div>
<div class="section" id="cancel-a-check">
<span id="http-ws-check-cancel"></span><h3>Cancel a Check<a class="headerlink" href="#cancel-a-check" title="Permalink to this headline">¶</a></h3>
<p>One can decide to cancel a pending check:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="n">exec</span><span class="o">(</span><span class="n">ws</span><span class="o">(</span><span class="s">&quot;Cancel Check&quot;</span><span class="o">).</span><span class="n">cancelCheck</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="section" id="build-a-check">
<span id="http-ws-check-build"></span><h3>Build a Check<a class="headerlink" href="#build-a-check" title="Permalink to this headline">¶</a></h3>
<p>Now, to the matter at heart, how to build a WebSocket check.</p>
<p><strong>Step 1: Blocking or non Blocking</strong></p>
<p>The first thing is to decide if the main HTTP flow is blocked until the check completes or not.</p>
<p><code class="docutils literal"><span class="pre">wsListen</span></code> creates a non blocking check: the main HTTP flow will go on and Gatling will listen for WebSocket incoming messages on the background.</p>
<p><code class="docutils literal"><span class="pre">wsAwait</span></code> creates a blocking check: the main HTTP flow is blocked until the check completes.</p>
<p><strong>Step 2: Set the Timeout</strong></p>
<p><code class="docutils literal"><span class="pre">within(timeout:</span> <span class="pre">FiniteDuration)</span></code></p>
<p><strong>Step 3: Exit condition</strong></p>
<p><code class="docutils literal"><span class="pre">until(count:</span> <span class="pre">Int)</span></code>: the check will succeed as soon as Gatling has received the expected count of matching messages</p>
<p><code class="docutils literal"><span class="pre">expect(count:</span> <span class="pre">Int)</span></code>: Gatling will wait until the timeout and the check will succeed if it has received the expected count of matching messages</p>
<p><code class="docutils literal"><span class="pre">expect(range:</span> <span class="pre">Range)</span></code>: same as above, but use a range instead of a single expected count</p>
<p><strong>Step 4: Matching condition</strong></p>
<p>Websocket checks support the same kind of operations as for HTTP bodies:</p>
<p><code class="docutils literal"><span class="pre">regex(expression:</span> <span class="pre">Expression[String])</span></code>: use a regular expression</p>
<p><code class="docutils literal"><span class="pre">jsonPath(path:</span> <span class="pre">Expression[String])</span></code>: use JsonPath</p>
<p><code class="docutils literal"><span class="pre">jsonpJsonPath(path:</span> <span class="pre">Expression[String])</span></code>: use JsonPath on a JSONP String</p>
<p>See <a class="reference internal" href="http_check.html#http-check"><span class="std std-ref">HTTP counterparts</span></a> for more details.</p>
<p><strong>Step 5: Saving</strong> (optional)</p>
<p>Just like regular HTTP checks, one can use checks for saving data into the virtual user’s session.</p>
<p>Here are an example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="n">exec</span><span class="o">(</span>
  <span class="n">ws</span><span class="o">(</span><span class="s">&quot;Send Message&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">sendText</span><span class="o">(</span><span class="s">&quot;hello, I&#39;m Stephane&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">check</span><span class="o">(</span><span class="n">wsListen</span><span class="o">.</span><span class="n">within</span><span class="o">(</span><span class="mi">30</span> <span class="n">seconds</span><span class="o">).</span><span class="n">until</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="n">regex</span><span class="o">(</span><span class="s">&quot;hello (.*)&quot;</span><span class="o">).</span><span class="n">saveAs</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">))</span>
<span class="o">)</span>
</pre></div>
</div>
</div>
<div class="section" id="reconciliate">
<span id="http-ws-check-reconciliate"></span><h3>Reconciliate<a class="headerlink" href="#reconciliate" title="Permalink to this headline">¶</a></h3>
<p>One complex thing is that, when using non blocking checks that save data, state is stored in a different flow than the main one.</p>
<p>So, one has to reconciliate the main flow state and the WebSocket flow one.</p>
<p>This can be done:</p>
<ul class="simple">
<li>implicitly when performing an action on the WebSocket from the main flow, such as send a message to the server</li>
<li>explicitly with the <code class="docutils literal"><span class="pre">reconciliate</span></code> method.</li>
</ul>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="n">exec</span><span class="o">(</span><span class="n">ws</span><span class="o">(</span><span class="s">&quot;Reconciliate states&quot;</span><span class="o">).</span><span class="n">reconciliate</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="configuration">
<span id="http-ws-check-conf"></span><h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>Websocket support introduces new parameters on HttpProtocol:</p>
<p><code class="docutils literal"><span class="pre">wsBaseURL(url:</span> <span class="pre">String)</span></code>: similar to standard <code class="docutils literal"><span class="pre">baseURL</span></code> for HTTP, serves as root that will be prepended to all relative WebSocket urls</p>
<p><code class="docutils literal"><span class="pre">wsBaseURLs(urls:</span> <span class="pre">String*)</span></code>: similar to standard <code class="docutils literal"><span class="pre">baseURLs</span></code> for HTTP, serves as round-robin roots that will be prepended to all relative WebSocket urls</p>
<p><code class="docutils literal"><span class="pre">wsReconnect</span></code>: automatically reconnect a WebSocket that would have been closed by someone else than the client.</p>
<p><code class="docutils literal"><span class="pre">wsMaxReconnects(max:</span> <span class="pre">Int)</span></code>: set a limit on the number of times a WebSocket will be automatically reconnected</p>
</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>Here’s an example that runs against <a class="reference external" href="https://www.playframework.com/download#older-versions">Play 2.2</a>’s chatroom sample (beware that this sample is missing from Play 2.3 and above):</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">httpConf</span> <span class="k">=</span> <span class="n">http</span>
  <span class="o">.</span><span class="n">baseURL</span><span class="o">(</span><span class="s">&quot;http://localhost:9000&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">acceptHeader</span><span class="o">(</span><span class="s">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">doNotTrackHeader</span><span class="o">(</span><span class="s">&quot;1&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">acceptLanguageHeader</span><span class="o">(</span><span class="s">&quot;en-US,en;q=0.5&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">acceptEncodingHeader</span><span class="o">(</span><span class="s">&quot;gzip, deflate&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">userAgentHeader</span><span class="o">(</span><span class="s">&quot;Gatling2&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">wsBaseURL</span><span class="o">(</span><span class="s">&quot;ws://localhost:9000&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">scn</span> <span class="k">=</span> <span class="n">scenario</span><span class="o">(</span><span class="s">&quot;WebSocket&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">exec</span><span class="o">(</span><span class="n">http</span><span class="o">(</span><span class="s">&quot;Home&quot;</span><span class="o">).</span><span class="n">get</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">pause</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
  <span class="o">.</span><span class="n">exec</span><span class="o">(</span><span class="n">session</span> <span class="k">=&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="s">&quot;Steph&quot;</span> <span class="o">+</span> <span class="n">session</span><span class="o">.</span><span class="n">userId</span><span class="o">))</span>
  <span class="o">.</span><span class="n">exec</span><span class="o">(</span><span class="n">http</span><span class="o">(</span><span class="s">&quot;Login&quot;</span><span class="o">).</span><span class="n">get</span><span class="o">(</span><span class="s">&quot;/room?username=${id}&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">pause</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
  <span class="o">.</span><span class="n">exec</span><span class="o">(</span><span class="n">ws</span><span class="o">(</span><span class="s">&quot;Connect WS&quot;</span><span class="o">).</span><span class="n">open</span><span class="o">(</span><span class="s">&quot;/room/chat?username=${id}&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">pause</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
  <span class="o">.</span><span class="n">repeat</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="s">&quot;i&quot;</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">exec</span><span class="o">(</span><span class="n">ws</span><span class="o">(</span><span class="s">&quot;Say Hello WS&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">sendText</span><span class="o">(</span><span class="s">&quot;&quot;&quot;{&quot;text&quot;: &quot;Hello, I&#39;m ${id} and this is message ${i}!&quot;}&quot;&quot;&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">check</span><span class="o">(</span><span class="n">wsAwait</span><span class="o">.</span><span class="n">within</span><span class="o">(</span><span class="mi">30</span><span class="o">).</span><span class="n">until</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="n">regex</span><span class="o">(</span><span class="s">&quot;.*I&#39;m still alive.*&quot;</span><span class="o">))</span>
  <span class="o">)</span>
    <span class="o">.</span><span class="n">pause</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="o">}</span>
  <span class="o">.</span><span class="n">exec</span><span class="o">(</span><span class="n">ws</span><span class="o">(</span><span class="s">&quot;Close WS&quot;</span><span class="o">).</span><span class="n">close</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>

          
        </div>
      </article>
    </main>
  </div>
</div>


<div class="sidebar-wrap col-md-3 content-left-wrap">
  <div id="secondary" class="widget-area" role="complementary" itemscope="itemscope"
       itemtype="http://schema.org/WPSideBar">
    <aside id="search-2" class="widget widget_search">
      <form role="form" method="get" class="search-form" action="../search.html">
        <label>
          <span class="screen-reader-text">Search through the documentation&nbsp;:</span>
          <input type="search" class="search-field" placeholder="Search the documentation" name="q">
        </label>
        <input type="submit" class="search-submit" value="Search">
      </form>
    </aside>
    <aside class="widget">
      <h1 class="widget-title">Table of Content</h1>
      <ul>
<li><a class="reference internal" href="#">WebSocket</a><ul>
<li><a class="reference internal" href="#common-operations">Common operations</a><ul>
<li><a class="reference internal" href="#open">Open</a></li>
<li><a class="reference internal" href="#close">Close</a></li>
<li><a class="reference internal" href="#send-a-message">Send a Message</a></li>
</ul>
</li>
<li><a class="reference internal" href="#server-messages-checks">Server Messages: Checks</a><ul>
<li><a class="reference internal" href="#set-a-check">Set a Check</a></li>
<li><a class="reference internal" href="#cancel-a-check">Cancel a Check</a></li>
<li><a class="reference internal" href="#build-a-check">Build a Check</a></li>
<li><a class="reference internal" href="#reconciliate">Reconciliate</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configuration">Configuration</a></li>
<li><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
</ul>

    </aside>
    
    <aside class="widget">
      <h1 class="widget-title">Previous topic</h1>
      <ul>
        <li>
          <a href="polling.html" title="Previous Chapter: HTTP Polling">
            HTTP Polling
          </a>
        </li>
      </ul>
    </aside>
    
    
    <aside class="widget">
      <h1 class="widget-title">Next topic</h1>
      <ul>
        <li>
          <a href="sse.html" title="Next Chapter: SSE (Server Sent Event)">
            SSE (Server Sent Event)
          </a>
        </li>
      </ul>
    </aside>
    <aside class="widget">
      <h1 class="widget-title">Contribute</h1>
      <ul>
        <li>
          <a href="https://github.com/gatling/gatling/edit/master/src/sphinx/http/websocket.rst">Edit this page on Github</a>
        </li>
      </ul>
    </aside>
  </div>
</div>





